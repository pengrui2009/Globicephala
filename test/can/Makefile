export TOPDIR = $(shell pwd)/../..

include $(TOPDIR)/config.mk



ifeq ($(J2735_PROTOCAL_TYPE), J2735_UN)
	SUBDIRS +=  $(TOPDIR)/protocol/J2735/SAE   \
		    $(TOPDIR)/protocol/J2735/SAE/codec  
else ifeq($(J2735_PROTOCAL_TYPE), J2735_CN)
	SUBDIRS +=  $(TOPDIR)/protocol/J2735/CSAE   \
		    $(TOPDIR)/protocol/J2735/CSAE/codec  
endif
OBJ_FILES = $(SUBDIRS:%=%/*.o)


#SRC_FILES := $(wildcard *.c) 
#OBJ_FILES += $(SRC_FILES:%.c=%.o)
#TARGET := $(SRC_FILES:%.c=%)

#ifeq ($(shell if [ -a $(DEPENDENCIES) ]; then $(ECHO) 1; fi),1)
#include $(DEPENDENCIES)
#endif

all:app image
	@
app:
	@for subdir in $(SUBDIRS); do \
		(cd $$subdir && $(MAKE) all) || exit 1; \
	done	
image:
	$(CC) $(CFLAGS) $(CFLAGS_DBG) -c bsm_encode.c -o bsm_encode.o
	$(CC) $(CFLAGS) $(CFLAGS_DBG) -c bsm_decode.c -o bsm_decode.o
	$(CC) $(OBJ_FILES) bsm_encode.o $(LDFLAGS) -o bsm_encode
	$(CC) $(OBJ_FILES) bsm_decode.o $(LDFLAGS) -o bsm_decode
	
$(DEPENDENCIES): $(SRC_FILES)
	@ $(ECHO) '##' > $(DEPENDENCIES)
	@ $(ECHO) '## This file is generated by "make"!' >> $(DEPENDENCIES)
	@ $(ECHO) '##' >> $(DEPENDENCIES)
	@for i in $^ ; do \
		$(CC) -M -MG $(CFLAGS) $$i >> $(DEPENDENCIES);  \
		$(ECHO) '##' >> $(DEPENDENCIES);	\
	done
	
ifeq ($(shell if [ -a $(DEPENDENCIES) ]; then $(ECHO) 1; fi),1)
include $(DEPENDENCIES)
endif

clean:
	rm -fr $(TARGET)
	@for subdir in $(SUBDIRS); do \
		(cd $$subdir && $(MAKE) clean) || exit 1; \
	done	
	-rm -f *.o $(DEPENDENCIES)
